define("cabin/lib/suggester/suggester",function(require){require("cabin/lib/suggester/suggester.css"),function(a,b,c,d){var e=function(b,c){this.$element=b,this.defaults={invalidMsg:"未通过验证",delay:300,separator:";"};this.options=a.extend({},this.defaults,c)};e.prototype={init:function(){function b(){n.find(".popup").html(x.join(",")+k.options.invalidMsg),o.css({visibility:"visible"})}function d(){o.css({visibility:"hidden"})}function e(a){v=v.filter(function(b){return b.id!==a.data("id")}),a.remove()}function f(){p.hide(),n.css({"z-index":1}),q.css({"border-bottom":"solid 1px #f5f5f5"})}function g(){n.css({"z-index":100}),q.css({"border-bottom":"none"}),p.show()}function h(){for(var a="",b=0,c=v.length;b<c;b++)a+=v[b].value+k.options.separator;m.val(a)}function i(b){return new Promise(function(c,d){var e={};e[k.options.remoteValidKeyName]=b,k.options.validUrl?a.ajax({url:k.options.validUrl,data:e,type:"GET"}).then(function(a){if(k.options.onRemoteValid){var e=k.options.onRemoteValid(b,a);e?(w.push(b),k.options.onRemoteValidSuccess(b),c("remoteValidComplete")):(k.options.onRemoteValidFail(b),x.push(b),d("remoteValidFail"))}else w.push(b),c("remoteValidComplete")},function(a){x.push(b),d("remoteValidFail")}):k.options.onRemoteValid(b).then(function(a){w.push(b),c("remoteValidComplete")})["catch"](function(a){x.push(b),d("remoteValidFail")})})}function j(b){var c=(new Date).getTime(),f=a('<li data-id="'+c+'" class="suggester-label-wrap"><label class="suggester-lb lb-'+b+'">'+b+'</label><i class="suggester-label-remove">x</i></li>');f.find(".suggester-label-remove").on("click",function(b){e(a(b.target).parent(".suggester-label-wrap"))}),v.push({value:b,id:c}),r.parents(".suggester-input-wrap").before(f),d()}var k=this,l=a(c.body),m=a(this.$element),n=a('<div class="suggester"><span class="custom popup top left transition visible">'+k.options.invalidMsg+"</span></div>"),o=n.find(".popup"),p=a('<ul class="suggester-key-list"></ul>'),q=a('<ul class="suggester-label-list"><li class="suggester-input-wrap"><input type="text" class="suggester-input"></li></ul>'),r=q.find(".suggester-input"),s=m.offset().left,t=m.offset().top,u=m.width();m.height();p.hide();var v=[],w=[],x=[];q.css({width:u}),n.append(q,p),l.append(n),n.css({position:"absolute",top:t,left:s});var y,z;return q.on("click",function(){r.focus()}),o.on("click",function(){d()}),r.on("keydown",function(b){var c=a(b.target);switch(b.keyCode){case 8:if(""===c.val()){var d=c.parents(".suggester-input-wrap").prev();c.val(d.find(".suggester-lb").html()),e(d)}break;case 38:var f=p.find(".suggester-key-item");f.hasClass("active")?f.filter(".active").removeClass("active").prev().addClass("active"):f.first().addClass("active");break;case 40:var f=p.find(".suggester-key-item");f.hasClass("active")?f.filter(".active").removeClass("active").next().addClass("active"):f.first().addClass("active");break;case 13:var f=p.find(".suggester-key-item");f.filter(".active").trigger("click")}}),l.on("click",function(a){d(),f()}),r.on("input",function(c){var d=a(c.target),e=d.val();if(k.options.url||k.options.onSuggest){var l=(new Date).getTime();l-y<k.options.delay&&clearTimeout(z),e&&(z=setTimeout(function(){if(k.options.url){var b={};b[k.options.remoteKeyName]=e,a.ajax({url:k.options.url,data:b,type:"GET"}).then(function(b){p.html(""),b.forEach(function(b){var c=a('<li class="suggester-key-item"><span>'+b+"</span></li>");c.on("click",function(){j(b),d.val(""),d.focus(),f()}),p.append(c)}),g()})}else k.options.onSuggest&&k.options.onSuggest(e).then(function(b){p.html(""),b.forEach(function(b){var c=a('<li class="suggester-key-item"><span>'+b+"</span></li>");c.on("click",function(){j(b),d.val(""),d.focus(),f()}),p.append(c)}),g()})["catch"](function(a){})},k.options.delay)),y=l}var m=e.split(k.options.separator);if(m.length>1){m.pop();if(k.options.validUrl||k.options.onRemoteValid)Promise.all(m.map(function(a){return i(a)})).then(function(){for(var a=0,b=m.length;a<b;a++)j(m[a]);h(),r.val(""),w=[],x=[]})["catch"](function(a){b(),w=[],x=[]});else{for(var n=0,o=m.length;n<o;n++)j(m[n]);h(),r.val("")}}}),this.$element}},a.fn.suggester=function(a){return this.each(function(){var b=new e(this,a);return b.init()})}}(jQuery,window,document)});